<!DOCTYPE html>
<html>
	<head>
		<title>Exercise</title>
		<meta charset="UTF-8">
		<style>
			.line{
				display:inline;
				white-space:nowrap;
			}

			.line span {
				display: inline-block;
				width:10%;
			}

			.line span:first-child {
				width:5%;
				text-align: left;
			}

			.line span:last-child {
				width:5%;
				text-align: right;
			}

			#outputElement {
				max-width: 45em;
				border: solid black;
				padding: 1em;
			}
			#settings{
				float:left;
				display: flex;
				padding: 1em;
			}
			#out{
				overflow: hidden;
				padding: 1em;
			}

			.together {
				display: inline-block
			}
		</style>
	</head>
	<body>
		<h1>Exercise</h1>
		<hr>
		<div id="settings">
			<fieldset>
				<legend>Settings</legend>
				<div>
					<input type="radio" id="fis" name="modie" value="fis" checked>
					<label for="fis">use fis</label><br>
					<input type="radio" id="ges" name="modie" value="ges">
					<label for="ges">use ges</label><br>
					<input type="radio" id="both" name="modie" value="both">
					<label for="both">use both</label><br>
					<br>
					<input type="number" id="amount" name="amount" value="1" min="1" style="width:4em">
					<label for="amount">number of lines</label><br>
					<input type="checkbox" id="recreate" name="recreate">
					<label for="recreate">recreate every time</label><br>
					<br>
					<input type="button" id="create" name="create" value="recreate" onclick="createNewContent()">
					<br>
					<input type="button" id="download" name="download" value="download" onclick="createAndDownload()">
				</div>
			</fieldset>
		</div>
		<div id="out">
			<center>
				<div id="output"></div>
			</center>
		</div>
		<script>
			const notes = ["C","B","A","G","F","E","D"]
			const fis = ["A#","G#","F#","D#","C#"]
			const ges = ["Bb","Ab","Gb","Eb","Db"]
			var   scrambeldNodes = []

			function createNoteArray(){
				var withFis = document.getElementById('fis').checked
				var withGes = document.getElementById('ges').checked
				var withboth = document.getElementById('both').checked

				var combined  = [];
				
				if(withboth){
					var combinedFisAndGes = [];
					var position = Array.from({length: 5}, () => Math.floor(Math.random() * 2));
					position.forEach( (arraySelector, index) => 
						{
							if(arraySelector == 1){
								combinedFisAndGes.push(fis[index]);
							}else{
								combinedFisAndGes.push(ges[index]);
							}
						}
					)
					combined = notes.concat(combinedFisAndGes);
				}else if(withFis){
					combined = notes.concat(fis);
				}else if(withGes){
					combined = notes.concat(ges);
				}
				
				return combined
			}

			function createRandomNodeArray() {
				var amount = document.getElementById('amount').value
				var withRecreate = document.getElementById('recreate').checked

				var combined = createNoteArray()

				scrambeldNodes = []
				for(var i = 0; i < amount; i++){
					if(withRecreate) combined = createNoteArray()
					scrambeldNodes.push([...combined].sort((a, b) => 0.5 - Math.random()))
				}
			}

			function sliceIntoChunks(arr, chunkSize) {
				const res = [];
				for (let i = 0; i < arr.length; i += chunkSize) {
					const chunk = arr.slice(i, i + chunkSize);
					res.push(chunk);
				}
				return res;
			}

			function createHTMLString(){
				var output = document.getElementById('output')

				const preText = "<p class=\"line\"><span>|</span><span>"
				const postText = "</span><span>|</span></p>"

				var textToShow = ""
				scrambeldNodes.forEach( exercice => {
					htmlExcercice = ""
					sliceIntoChunks(exercice,4).forEach( parts => {
						htmlExcercice += preText + parts.join("</span><span>|</span><span>") + postText
					})
					
					
					textToShow += "<div id=\"outputElement\">"+ htmlExcercice + "</div><br><br>"	
				})

				output.innerHTML = textToShow
			}

			function createTextForFile(){
				const header = "####################\n#\tExercice\n####################\n\n\n"
				const preText = "|    "
				const postText = "    |"
				var data = header

				scrambeldNodes.forEach( (element,idx) => {
					const middleIndex = Math.ceil(element.length / 2);

					const firstHalf = element.splice(0, middleIndex);   
					const secondHalf = element.splice(-middleIndex);

					var t = "Excercice "+  (idx+1) + ":\n" + preText+ firstHalf.join("    |    ") + postText + "\n" + preText+ secondHalf.join("    |    ") + postText
					data += t + "\n\n"	
				})
				return data
			}

			function createAndDownload(data, filename, type) {
				if(scrambeldNodes.length == 0){
					createRandomNodeArray()
					createHTMLString()
				}

				var data = createTextForFile()

				var type = "text/plain"
				var filename = "exercice.txt"
				var file = new Blob([data], {type: type});
				if (window.navigator.msSaveOrOpenBlob) // IE10+
					window.navigator.msSaveOrOpenBlob(file, filename);
				else { // Others
					var a = document.createElement("a"),
							url = URL.createObjectURL(file);
					a.href = url;
					a.download = filename;
					document.body.appendChild(a);
					a.click();
					setTimeout(function() {
						document.body.removeChild(a);
						window.URL.revokeObjectURL(url);  
					}, 0); 
				}
			}

			function createNewContent(){
				createRandomNodeArray()
				createHTMLString()
			}

			createNewContent()
		</script>
	</body>
</html>